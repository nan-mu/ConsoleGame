**C/C++****语言程序设计**

**综合上机实验（****8****学时）**

**一、** **实验名称：****BlackJack****编程框架和洗牌的实现**

**二、** **实验机时：****8****学时**

**三、** **实验目的**

1、学习项目规划，搭建项目和新建类。BlackJack（黑杰克）也就是21点打牌游戏，对于完整的项目设计，棋牌类游戏可能不止一种，因此前期需要对项目进行规划，我们将整个项目命名为ConsoleGame（控制台游戏项目），而21点游戏作为项目中的一种牌类游戏，将其打牌所需要的数据和过程函数封装在CBlackJack类内。这样，以后ConsoleGame项目可以继续扩展新游戏，只要把新游戏封装在新建的类中即可。

2、学习ADT抽象和由顶向下设计，搭建基于类的21点游戏程序框架。通过VS2019的项目菜单，添加新类CBlackJack，建立21点游戏类。然后思考21点游戏需要操作哪些数据（每种数据对应于CBlackJack类的一个成员变量）？打牌过程可以分解为几个子过程（每个子过程对应于CBlackJack类的一个成员函数）？这些成员函数的作用是什么，输入和输出是什么？这样就可以抽象出函数的形式框架，而具体的实现代码留待下一步细化。当成员变量、成员函数的形式全部确定后，基于类的编程框架基本就搭建好了。

3、学习随机数的产生和使用，完成洗牌函数的具体实现，并测试通过。随机数对于任何游戏都是重要的，游戏的魅力之一就是随机性。

4、通过项目实践，巩固数据类型、控制结构等基本知识、掌握项目和类的关系、类编程的要点、类成员函数的设计实现、熟练编译和调试技巧。

**四、** **实验内容**

1、建立控制台游戏编程项目。

2、向项目中添加新类21点游戏类，该类具体实现基于计算机程序21点双人对战过程，21点游戏作为控制台游戏项目的其中一种游戏。

3、为实现黑杰克（21点）扑克游戏编程，首先阅读理解以下简化版的21点游戏规则，并先重点关注步骤（1）的洗牌，因为本实验除了搭建项目框架，就是实现洗牌函数，而整个打牌过程的计算机实现是在课程设计中。

（1）两个人（以下我们称为甲乙，英文名为player1和player2）共玩一副扑克牌（大小王拿掉不要），剩下的是桃心梅方4种花色，每种13张牌，一共52张牌，每种花色的13张牌分别是2~10的小点数牌和J、Q、K、A四种花牌，玩前先随机洗牌；

（2）进行一轮要牌过程（本回合开始）：甲乙分别循环要牌比大小（甲乙双方在要牌过程中都不知道对方是什么牌），每次都是先甲要牌，然后轮到乙要牌。在每次要牌时，甲或乙都可以根据自己手上牌决定这次要还是不要，但如果这次没要，下次就不能再要了。甲乙的要牌的总数量在2-5之间，即每人最少必须要2张牌，最多不得超过5张牌。

（3）甲乙比牌点：算自己手上牌的总分，总分超过21点算“爆”，输了；如果两个人都“爆”，则爆的少的人赢（总分-21小的人赢）；都没爆的情况下，谁的总分高谁赢。

（4）牌点的算法：2~10的牌按牌面算分，即2牌一张就是2分；花牌J、Q、K每张算10分；花牌A是一个变数，既可以当1分算，也可以当11分算，按照最有利玩家的算法算（即在不爆的情况下点数最大为原则）

（5）比完一次（本回合结束），对本次输赢情况记录，在剩下的牌中继续要牌和比点，即每人手上牌清零，然后返回（2）进入下一回合要牌比点。

（6）当已经没有剩余牌（52张牌已经被两玩家拿光）的时候游戏结束，统计各回合输赢情况并给出最后整个游戏谁最终胜利和失败，赢的次数较多的玩家为最终胜利者，如果赢的次数一样算和。

**五、** **实验思路与步骤**

**1、** **建立项目**

建立一个名为ConsoleGame的win32控制台项目，项目名和主文件名都为ConsoleGame,，ConsoleGame,项目的含义是控制台游戏项目。

**2、** **添加****21****点游戏类**

向项目中添加新类CBlackJack，该类具体实现基于计算机程序21点双人对战过程。添加的新类应该会有.h和,cpp两个文件，尝试通过类视图访问类。

**3****、类成员函数—洗牌函数的规划**

洗牌是所有牌类游戏的共性出发点，一个扑克牌类游戏一般可以抽象成这样几个过程：洗牌、发牌或拿牌、出牌、比牌、基于比牌结果的后续处理，然后循环回去，重新发牌或拿牌，直到牌打完，最后会有一个优胜规则（裁判规则）。

把重点聚焦在洗牌函数的设计上：

（1）给洗牌函数起名：先给洗牌函数一个名字，就叫WashCrads吧

（2）根据功能是否独有决定是否继承：洗牌函数WashCrads是21点游戏类CBlackJack独有的还是继承的？由于洗牌是所有扑克牌游戏的共性功能，为了项目以后的扩展性，所以我们似乎有必要添加一个新的扑克牌基类CPorkGame，并把洗牌函数作为CPorkGame类的成员函数，这样比较合理。

（3）考虑外部代码是否可以直接调用洗牌函数：外部代码直接调用类成员的洗牌函数，也没什么大毛病，不过面向对象编程的要点是，所有不必要外部知道和直接访问的就对外屏蔽掉，这样一个类具有较少的接口函数和接口数据，类的独立性比较好便于维护，因此洗牌既然是共性的，那么其实可以机器自动洗牌，即在开始一个游戏的时候就洗好，而无需外接干预。所以洗牌最好是放在类的构造函数里，这样一旦创建游戏类实例，牌就洗好了。既然如此，洗牌的访问限制应该就是private或protected，外部代码不能直接访问；那么到底洗牌应该是private还是protected访问限制？由于洗牌在扑克牌基类CPorkGame里，派生类CBlackJack是不能直接访问基类的私有成员的，但是方才我们已经想好了要把洗牌放在基类CPorkGame的构造器里，而子类构造过程是先隐形调用基类构造器，这样CBlackJack在创建游戏实例的时候就能间接地调用到了基类私有的洗牌函数，所以洗牌函数应该是CPorkGame的一个私有函数（private），C++面向对象编程要点，访问权限能给最低的就给最低的。这样避免随便乱访问。

（4）洗牌函数操作的数据是什么？这些数据是否要放在函数的参数里？

洗牌，自然是操作52张牌，52张牌这么多肯定要用数组存放啊。所以洗牌所操作的数据都是52张牌的数组，那么这52张牌开始是什么状态？假设是新牌，开始的状态是按桃心梅方花色1-K顺序存放的，洗牌是要将这些顺序打乱，而且是随机打乱，即每次洗牌后的牌在数组中的存放顺序都是不同的。

现在先不管洗牌函数具体怎么实现，先考虑一下洗牌函数的形式，既然输入的数据是顺序存放的牌数组，输出是打乱的牌数组。其实就是洗牌的输入输出数据都是同一个牌数组，如果要传参就是传这个数组了。但是我们还需要考虑一下有没有必要传数组？这个涉及一个问题，就是牌数组只是洗牌还是要用，还是CBlackJack类的其他打牌过程函数也要用？拿牌函数要不要用？比牌函数要不要用？亮牌函数要不要用？显然，牌数组并非只有洗牌函数用，其他打牌过程函数也要用到，所以牌数组似乎不比传参，而是作为类的一个共享成员，可以被后续打牌函数共用。这是类成员函数设计和非类成员的普通函数设计的一个最大不同，对于普通函数而言，函数的独立性很重要，所以尽量和应该参数化设计，而对于类成员函数，很多成员函数需要共用的数据，一般就不传参而是作为类成员变量给类中的所有成员函数共享，这样可以简化函数设计。最后我们考虑下洗牌函数是否需要返回值？应该不需要，输入和输出数据已经使用了本类的共享成员数组，除非你不确定洗牌是否总能顺利实现（洗牌是否成功用bool返回），但是那样是你算法设计上毛病，正常情况下没有不成功的，所以洗牌函数不需要返回值，即void型。

**现在总结一下本步骤的规划结论：**

l 新建一个扑克牌基类CPorkGame，并向该类添加一个私有成员函数WashCards，该函数无需参数，函数返回值类型void，在类头.,h文件里声明该成员函数，在类体,cpp文件里定义好该函数空框架.；

l 以CPorkGane为基类，公有派生出子类CBlackJack。

**4****、类成员变量—牌数组的规划**

通过步骤3的分析，我们已经确定了CBlackJack类需要一个牌数组的成员变量，那么有几个问题需要先考虑好：

第一，      这个牌数组是放在基类CPorkGame里还是子类CBlackJack里好？由于WashCrads洗牌函数是在基类中，所以牌数组只能放在基类里，因为基类的函数是无法操作子类成员的基类诞生的时候并不知道有子类的存在，而且以后会新增哪些子类也不知道。

第二，      牌数组如何组织，是一维数组还是二维数组？由于牌数组是扑克牌基类成员，那么虽然21点游戏无需考虑花色，但打其他牌游戏会要考虑花色，所以表示一张牌需要花色和牌面值两个属性，但这并不表示就要用二维数组。因为牌其实是按一定顺序摞起来的，相当于是一个序列，因此还是一维数组，是52个元素的数组序列，但每个元素需要两种属性怎么办？结构数组啊。

第三，      怎么表示桃心梅方花色值？最简单就是用数字1234分别表示吧，那么这个值是什么类型？1、2、3、4都是很小的整数，char或unsigned char足矣够用了。

第四，      怎么表示牌面值？用字符’2’~‘9’和’A’、‘J’、 ‘Q’、 ‘K’原样表示都没问题，有问题是面值10的牌，一个单字符是没法表示的，所以面值10要做变通表示，例如用字符’’D’表示面值10

第五，      给牌数组起一个名字，按照匈牙利命名法，既然是类的数据成员，一般以m_开头，就叫m_cards[52]吧 

第六，      牌数组的访问限制，虽然洗牌不需要外部知道，但是洗牌的结果，可能需要外部检查一下吧，所以还是public吧。

**现在总结一下本步骤的规划结论：**

给CPorkGame类新加一个访问属性为public的52元素的成员数组m_cards[52]，该数组的每个元素都是一个结构体，结构体由花色和面值两个成员构成。元素在牌数组中的序号即其存放的顺序。所以洗牌就是将元素存放的顺序随机打乱。

**5、** **完成洗牌函数体的具体定义代码**

**（****1****）产生随机数**

首先涉及如何产生随机数的问题。随机数的产生，是使用C语言库函数srand和rand函数来实现的，rand函数会产生随机数，但如果只使用了rand函数，那么每次重启程序产生的随机序列是一样的，这样就没意思了。所以在使用rand函数之前，要先使用srand函数（其参数是一个随机种子time(0)），使用当前时间为随机种子，可以得到不同的伪随机序列，因为时间是不可能重复的。关于如何使用库函数rand和srand，请大家自行尝试使用百度、\CSDN和MSDN检索相关信息，库函数的使用，不属于语言本身，必须自己学会检索使用，这是一项基本技能，这样才可以想做什么就扩展什么知识。

**（****2****）随机数的作用**

产生的随机数怎么用？我们考虑一下洗牌要干什么？洗牌就是改变排序，那么我们可以这样想象洗牌过程，首先你从牌数组顺序拿出一张牌，然后把他放入随机的位置，然后再拿一张牌再放入一个新的随机位置。但是问题来了，随机的位置本来就有另一张牌，你放入了那张牌怎么办？顺序后推吗，不可以的，也许推出牌最大序号51了。

所以，我们在洗牌函数里可能需要一个倒换的临时数组（函数内部的局部变量）。先将52张牌按新牌顺序放入临时数组，然后清空牌数组，再从临时数组中一张张顺序取出牌，放入牌数组的随机位置。

这里还有一个问题，随机值冲突问题，如果前某张牌的随机序号和现在要随机放置的牌的随机序号相同，那又出现了牌位冲突的问题。所以我们要对清空后的牌数组做一个标记，清空时，牌数组的每个元素的面值都是0（0是不存在的牌面值），这样，我们根据随机值0-51，并非是直接放入数组的对应序号，而是数面值不是0的地方放入，举例来说，现在要随机放的牌随机值是32，并不是直接放入m_cards[32]，而是遍历整个m_cards数组数空位，数到第33个尚未放牌的地方放入，所以随机值的用途是空位序号。

显然，随着一张张牌放入，空位是越来越少的。而rand函数产生的数是很大的范围，几乎是整个int的取值范围，因此，要规整到0-51个数之间，而且在每放一张牌后要递减模数

比如放第一张牌的时候空位序号是rand()%52，放第二张牌的空位序号就是rand%51，放最后一张牌就只剩余一个空位了，没得选择。

**6、** **生成****21****点游戏实例并隐形调用洗牌**

在main函数里，使用CBlackJack的默认构造器创建CBlackJack类的对象实例，完成洗牌。

**7****、洗牌结果的检查呈现**

（1）在main函数里，通过步骤6创建的CBlackJack类的对象实例，访问该对象的成员数据牌数组m_cards，并按每行13张展开呈现52张牌的洗牌结果，即按数组序号呈现每个序号上放的牌（每张牌的表示是自然语言表示，例如梅花10、红桃K）

（2）重新运行程序，显示第二次程序运行时的洗牌结果，检查两次洗好的牌序是否雷同，不雷同就对了。

**六、** **实验要求**

本编程项目综合性较强，所以要提前预习和预编程，尽可能独立完成，以便针对知识点的掌握的不熟悉的地方和存在误解的地方，在上机8小时通过调试和讨论答疑解决和巩固，课后提交实验报告。课上未完成编程调试出结果的课后继续完成，但会对实验成绩有一定影响。实验成绩根据现场完成情况、最终完成情况、动手情况/调试能力两方面综合评分，不排除老师在实验课上就程序和调试问题进行随机提问。

签到和当堂验收环节不能省，题目可以先做，若提前完成的，可以直接签到后验收完先走。

 

**七、** **实验成果提交和验收**

1、本周日晚十点前提交给助教源码项目文件夹（包括工程的所有文件和源代码文件）和运行截图JPG，非2019开发的文件夹中要有TXT文件说明开发环境，个人打包以：班级-学号-姓名命名文件夹，汇总给学委打包全班zip发。稍后老师会根据源码和截图汇总批改，并就存在疑问的代码随机取三段代码询问设计人（12月底前，要求大家能保持经常在线，否则老联系不上就当回答不来了，会影响成绩）。12月底前交电子版报告给助教。

2、按照实验报告格式要求撰写实验报告 ，并打印纸质实验报告交给学委（开学初一周内）。学委汇总纸质报告交给助教，其中本班项目软件包可以打包rar发电子档，实验报告纸质版交到222实验室王胜甜助教。

3、实验成绩：按百分制计分，提交软件包代码简洁规范性、思路清晰质量评估40分，实验报告质量30分；随机抽检30分。实验总成绩占课程总成绩的10%

 

**八、** **实验时间和地点**

实验时间：12月12月12日周四下午14:00-17:00

实验地点：线上

 

 

 

 

 

 

 

 

**附件一** **代码质量检查表**

**班号：学号：姓名：**

| **功能点序号** | **功能完成项**                     | 检查结果 |
| -------------- | ---------------------------------- | -------- |
| 1              | 洗牌是否实现随机乱序放牌           |          |
| 2              | 两次洗牌是否排序不同               |          |
| 3              | 代码中变量命名是否规范             |          |
| 4              | 代码是否有必要的注释               |          |
| 5              | 代码是否思路清晰、分段逻辑性强     |          |
| 6              | 代码中的循环、分支嵌套是否层次清晰 |          |
| 7              | 是否遵循了类编程规范               |          |
| 8              | 是否使用了构造器知识               |          |
| 9              | 是否使用了继承知识                 |          |
| 10             | 抽查代码段1的答辩结果              |          |
| 11             | 抽查代码段2的答辩结果              |          |
| 12             | 抽查代码段3的答辩结果              |          |

备注：每个功能点圆圈表示完全不行，半勾表示尚可，全勾表示很好。

 